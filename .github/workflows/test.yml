name: Lienol Build

on:
  push:
    branches:
      - master

jobs:

  build:
    runs-on: ubuntu-18.04
    steps:

      - uses: actions/checkout@master

      -
        name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "Asia/Shanghai"

      -
        name: 拉取源码
        run: |
          cd ${{ github.workspace }}
          git clone --depth 1 -b dev-master https://github.com/Lienol/openwrt.git openwrt
          cd openwrt
          useVersionInfo=$(git show -s --date=short --format="Author: %an<br/>Date: %cd<br/>Commit: %s")
          echo "::set-env name=useVersionInfo::$useVersionInfo"
          echo "::set-env name=DATE::$(TZ=UTC-8 date "+%Y%m%d")"
          echo "::set-env name=RELEASE_DATE::$(TZ=UTC-8 date "+%Y-%m-%d")"

      -
        name: 更新组件
        run: |
          cd ${{ github.workspace }}/openwrt
          echo "" >> feeds.conf.default
          echo "src-git passwall https://github.com/kenzok8/openwrt-packages.git" >> feeds.conf.default
          ./scripts/feeds clean
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      -
        name: 开启SSH
        uses: P3TERX/debugger-action@master

      -
        name: 编译下载
        run: |
          cd ${{ github.workspace }}/openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      -
        name: 编译
        run: |
          mkdir -p ${{ github.workspace }}/dist/Packages
          cd ${{ github.workspace }}/openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s 2>&1 | tee ${{ github.workspace }}/dist/build.log
          echo ::set-env name=BUILD_STATUS::"success"
          echo ::set-env name=RELEASE_TAG::"$(TZ=UTC-8 date +"%Y.%m.%d-%H")"

      -
        name: 整理文件
        id: organize
        if: env.BUILD_STATUS == 'success' && !failure()
        run: |
          cp -r -f ${{ github.workspace }}/openwrt/bin/targets/*/*/* ${{ github.workspace }}/dist/
          cp -r -f ${{ github.workspace }}/openwrt/bin/packages/*/* ${{ github.workspace }}/dist/Packages/
          cd ${{ github.workspace }}/dist/
          tar -zcvf Packages.tar.gz Packages
          rm -rf Packages

      -
        name: 上传奶牛快传
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 99 -t 3 --hash --no-progress ${{ github.workspace }}/openwrt/bin/targets 2>&1 | tee cowtransfer.log
          echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          echo "::set-env name=COWTRANSFER_URL::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"
          echo ${{ env.COWTRANSFER_URL }}