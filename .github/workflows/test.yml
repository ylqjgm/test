name: Lean Build

on:
  push:
    branches:
      - master
  schedule:
    - cron: 0 23 * * 6

jobs:

  build:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@master

      -
        name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo swapoff /swapfile
          sudo rm -rf /swapfile /etc/apt/sources.list.d/*
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs git-core gcc-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler
          curl -fsSL https://raw.githubusercontent.com/P3TERX/dotfiles/master/.bashrc >> ~/.bashrc
          sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      -
        name: 拉取源码
        run: |
          cd ${{ github.workspace }}
          git clone --depth 1 -b master https://github.com/coolsnowwolf/lede.git openwrt
          cd openwrt
          useVersionInfo=$(git show -s --date=short --format="Author: %an<br/>Date: %cd<br/>Commit: %s")
          echo "::set-env name=useVersionInfo::$useVersionInfo"
          echo "::set-env name=DATE::$(TZ=UTC-8 date "+%Y%m%d")"
          echo "::set-env name=RELEASE_DATE::$(TZ=UTC-8 date "+%Y-%m-%d")"

      -
        name: 更新组件
        run: |
          cd ${{ github.workspace }}/openwrt
          git clone https://github.com/ylqjgm/luci-app-passwall.git
          cp -r -f luci-app-passwall/* package/lean/
          git clone https://github.com/project-openwrt/luci-app-unblockneteasemusic-mini.git package/lean/luci-app-unblockneteasemusic-mini
          git clone https://github.com/sypopo/luci-theme-argon-mc.git package/lean/luci-theme-argon-mc
          ./scripts/feeds clean
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      
      -
        name: 自定义命令
        run: |
          cd ${{ github.workspace }}
          chmod +x diy.sh
          ./diy.sh
          rm -rf openwrt/package/default-settings/files/zzz-default-settings
          cp -f zzz-default-settings openwrt/package/lean/default-settings/files/

      -
        name: 自定义配置
        run: |
          cd ${{ github.workspace }}/openwrt
          rm -f .config
          cp ${{ github.workspace }}/lean.config ${{ github.workspace }}/openwrt/.config
          sed -i 's/^[ \t]*//g' ./.config
          make defconfig

      -
        name: 编译下载
        run: |
          cd ${{ github.workspace }}/openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      -
        name: 编译
        run: |
          cd ${{ github.workspace }}/openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s
          echo ::set-env name=BUILD_STATUS::"success"
          echo ::set-env name=RELEASE_TAG::"$(TZ=UTC-8 date +"%Y.%m.%d-%H")"

      -
        name: 链接SSH
        uses: P3TERX/debugger-action@master

      -
        name: 上传奶牛快传
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 99 -t 3 --hash --no-progress ${{ github.workspace }}/openwrt/bin/targets/*/*/ 2>&1 | tee cowtransfer.log
          echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          echo "::set-env name=COWTRANSFER_URL::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"
          echo ${{ env.COWTRANSFER_URL }}