name: Lienol Build

on:
  push:
    branches:
      - master

jobs:

  build:
    runs-on: ubuntu-18.04
    steps:

      - uses: actions/checkout@master

      -
        name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "Asia/Shanghai"

      -
        name: 拉取源码
        run: |
          cd ${{ github.workspace }}
          wget -c https://github.com/upx/upx/releases/download/v3.96/upx-3.96-src.tar.xz
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 99 -t 3 --hash --no-progress ${{ github.workspace }}/upx-3.96-src.tar.xz 2>&1 | tee cowtransfer.log
          echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          echo "::set-env name=COWTRANSFER_URL::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"
          echo ${{ env.COWTRANSFER_URL }}
